<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
   
  <meta http-equiv="content-type" content="text/html; charset=ISO-8859-2">
  <title>Seksi commander</title>
</head>
  <body>
 
<h1><a name="mozTocId207002" class="mozTocH1"></a>Seksi Commander - technická
dokumentace<!--mozToc h1 1 h2 2 h3 3 h4 4--><br>
 </h1>
 
<ul id="mozToc">
   <a href="#mozTocId831747">Úvod a pøeklad </a><br>
   <a href="#mozTocId716471">Doporuèený styl (©tábní kultura)</a>   
  <ul>
     <li><a href="#mozTocId886065">Volba názvù promìnných</a></li>
     <li><a href="#mozTocId135508">Volba názvù souborù</a></li>
     <li><a href="#mozTocId190975">Volba názvù konstant</a></li>
     <li><a href="#mozTocId29864">Volba názvù globálních promìnných</a></li>
     <li><a href="#mozTocId156730">Styl kodování</a></li>
   
  </ul>
   <a href="#mozTocId643223">Lokalizace </a>   
  <ul>
     <li><a href="#mozTocId702853">Lokalizace formuláøù </a></li>
     <li><a href="#mozTocId969999">Lokalizované zprávy </a></li>
   
  </ul>
   <a href="#mozTocId336128">Práce s archívy</a><br>
   <a href="#mozTocId648487">Portace</a>   
  <ul>
     <li><a href="#mozTocId994230">Windows</a></li>
     <li><a href="#mozTocId60923">Lazarus</a></li>
   
  </ul>
 
</ul>
 
<h2><a name="mozTocId831747" class="mozTocH2"></a>Úvod a pøeklad<br>
 </h2>
Seksi Commander je napsán v Object Pascalu pod Kylixem a výsledkem je nativní
32 bit ELF aplikace nezávislá na KDE, GNOME. Pro zobrazování pou¾ívá upravenou
knihovnu QT od Borlandù a tudí¾ je zaruèena stejná funkènost.<br>
Program se musí dát pøelo¾it pod Kylix 3 Open Edition. Pro správný pøeklad 
editoru z GUI musí být nainstalované komponenty synedit (a to z CSV ze sourceforge
nebo ty co jsem dal ke sta¾ení)
a pro pøeklad Vieweru z GUI moje komponenta QViewerControl (souèástí zdrojových
textù).<br>
 Pro pøeklad pomocí dcc32 si myslím, ¾e by staèilo pøidat cesty ke zdrojákùm
uvedených komponent (nezkou¹el jsem).<br>
 Jinak kompletní build, vèetnì SynEditu má asi 77000 øádku za 3 sekundy na mém Duronu
650 se 128 MB a Gnome. Normální kompilace a spu¹tìní asi tak sekundu :-).<br>
<br>
 
<h2><a name="mozTocId716471" class="mozTocH2"></a>Doporuèený styl (©tábní
kultura)</h2>
 
<h3><a name="mozTocId886065" class="mozTocH3"></a>Volba názvù promìnných</h3>
 Promìnné jsou pojmenovávány pokud mo¾no logicky a v souladu s jejich urèením.
Pro lokální promìnné je mo¾no pou¾ít i jednopísmenné pojmenování jako i,
j, nebo obecné názvy jako temp. Ve vìt¹inì pøípadù je doporuèeno pou¾ívat
prefixy indikující typ promìnné, viz. tabulka.<br>
 <br>
 
<table cellpadding="2" cellspacing="2" border="1" style="text-align: left; width: 100%;">
   <tbody>
     <tr>
       <td style="vertical-align: top; font-weight: bold;">Typ promìnné<br>
       </td>
       <td style="vertical-align: top; font-weight: bold;">Prefix<br>
       </td>
       <td style="vertical-align: top; font-weight: bold;">Pøíklad<br>
       </td>
     </tr>
     <tr>
       <td style="vertical-align: top;">stringové typy<br>
       </td>
       <td style="vertical-align: top;">s<br>
       </td>
       <td style="vertical-align: top;"><tt>sPath</tt><br>
       </td>
     </tr>
     <tr>
       <td style="vertical-align: top;">Celoèíselné typy<br>
       </td>
       <td style="vertical-align: top;">i<br>
       </td>
       <td style="vertical-align: top;"><tt>iCount</tt><br>
       </td>
     </tr>
     <tr>
       <td style="vertical-align: top;">Boolean<br>
       </td>
       <td style="vertical-align: top;">b<br>
       </td>
       <td style="vertical-align: top;"><tt>bChecked</tt><br>
       </td>
     </tr>
     <tr>
       <td style="vertical-align: top;">typové promìnné a tøídy<br>
       </td>
       <td style="vertical-align: top;">T<br>
       </td>
       <td style="vertical-align: top;"><tt>TTable</tt><br>
       </td>
     </tr>
     <tr>
       <td style="vertical-align: top;">výèty<br>
       </td>
       <td style="vertical-align: top;">kombinace jména typu a hodnoty</td>
       <td style="vertical-align: top;"><tt>Type TColor=(clRed, clGreen)</tt></td>
     </tr>
     <tr>
       <td style="vertical-align: top;">pointery<br>
       </td>
       <td style="vertical-align: top;">P<br>
       </td>
       <td style="vertical-align: top;"><tt>PData</tt> (napø. <tt>Type PData=^TData</tt>
)<br>
       </td>
     </tr>
   
  </tbody> 
</table>
 
<h3><a name="mozTocId135508" class="mozTocH3"></a>Volba názvù souborù</h3>
 
<table cellpadding="2" cellspacing="2" border="1" style="text-align: left; width: 100%;">
   <tbody>
     <tr>
       <td style="vertical-align: top;">Formuláøe<br>
       </td>
       <td style="vertical-align: top;">frmXXX v souboru fXXX.pas<br>
       </td>
       <td style="vertical-align: top;">frmCopyDlg v souboru fCopyDlg.pas<br>
       </td>
     </tr>
     <tr>
       <td style="vertical-align: top;">Unity<br>
       </td>
       <td style="vertical-align: top;">uXXX.pas<br>
       </td>
       <td style="vertical-align: top;">uFileCopy.pas<br>
       </td>
     </tr>
     <tr>
       <td style="vertical-align: top;">Data moduly<br>
       </td>
       <td style="vertical-align: top;">dmXXX v souboru dXXX.pas<br>
       </td>
       <td style="vertical-align: top;">dmDialogs v souboru dDialogs.pas<br>
       </td>
     </tr>
     <tr>
       <td style="vertical-align: top;"><br>
       </td>
       <td style="vertical-align: top;"><br>
       </td>
       <td style="vertical-align: top;"><br>
       </td>
     </tr>
   
  </tbody> 
</table>
 <br>
 
<h3><a name="mozTocId190975" class="mozTocH3"></a>Volba názvù konstant</h3>
 Konstanty zaèínají písmenem c a pak je zkratka funkce a zkratka významu.
Napø. <tt>cLngMsgErrCpFile=10</tt>.<br>
 
<h3><a name="mozTocId29864" class="mozTocH3"></a>Volba názvù globálních promìnných</h3>
 Konstanty zaèínají písmenem g a pak je zkratka funkce a zkratka významu.
Napø. <tt>gLynxLike:=False;</tt><br>
 
<h3><a name="mozTocId156730" class="mozTocH3"></a>Styl kodování</h3>
 Je preferován objektový pøístup (tøídy a objekty), ale v nìkterých pøípadech
je výhodnìj¹í pou¾ít èistì neobjektový kód a pak je to samozøejmì mo¾né.
Pokud existuje skupina funkcí, které si navzájem pøedávají nìkolik parametrù,
mìli by být nahrazeny tøídou a jejími metodami.<br>
 <br>
 Místo volání Free pou¾ívat konstrukci <br>
 
<pre>  if assigned(objekt) Then <br>    FreeAndNil(objekt)<br></pre>
 Nekompromisnì pou¾ívat vyjímky. Sna¾it se pro akci, která mù¾e být vyvolána
z nìkolika míst (napø. menu, popupmenu, toolbar) pou¾ívat ActionListy.<br>
 
<pre>objekt:=TTrida.Create;<br>try<br>  // nejake akce s objekt <br>finally<br>  if assigned(objekt) Then <br>    FreeAndNil(objekt)<br>end;<br></pre>
 nebo 
<pre>otevøi soubor<br>try<br>  operace se souborem<br>finally<br>  zavøi soubor<br>end;<br></pre>
 Zaroveò je ve vhodných okam¾icích dobré pøemý¹let o try...except..end. V
tom pøípadì zpracovat jen ten druh vyjímky, ostatní publikovat vý¹e pomocí
Raise.<br>
 <br>
 <span style="font-weight: bold;">Jiné:</span> Zarovnává se na dva znaky, 
pokud je tìlo funkce del¹í ne¾ nìjakých 15-20 øádkù (ale i ménì nebo více),
je vhodné pøemý¹let o rozdìlení do více funkcí.<br>
 Sna¾it se psát kód pøímoèaøe a vyu¾ívat vyjímky. Nezapomenout ¾e pokud zavoláme
<tt>Exit</tt> v bloku <tt>try..finally</tt>, tak se provede èást <tt>finally</tt>
.<br>
 
<pre>function BlaBle(const sFileName:String):String;<br>begin<br>  Result:='';<br>  if sFileName='' then Exit;<br>  if ExtractFileName(sFileName)&lt;&gt;'.bla' then<br>    Result:='ble'<br>  else<br>    Result:='bla';<br>end;<br></pre>
 Kde se pøedávají konstatní parametry, tam je specifikujte pomocí <tt>const.</tt><br>
 Program se musí dát ovládat pouze z klávesnice.<br>
 <h2>Vytváøení formuláøù</h2>
 V¹echny formuláøe musí být vytváøeny a¾ za bìhu (vyjímku tvoøí frmMain a datavé moduly).<br>
 Osvìdèilo se mi pøidat k formuláøi funkci, která má parametry nutné pro pøedání dat
 formuláøi (napø. seznam souborù pro Viewer) a která je volána z nadøízeného formuláøe.<br>
 napø:
 <pre>
 function ShowEditForm(const sFileName:String):boolean;
 begin
   with TfrmEditor.Create(Application) do
   begin
     try
// zde je jiz formuláø vytvoøen a jeho vlastníkem je objekt Application
// tudí¾ zde si mù¾eme s ním dìlat co chceme, pøedat data apod.
       if ShowModal=mrOK then
       begin
         // ha, user stisknul OK tlaèítko, co s tím udìláme?
       
       end
       else
       begin
         // stisknul nìco jiného

       end;
{ je pou¾ita try.. finally, proto¾e a» u¾ v pøípadì jakékoliv vyjímky, nebo
 v pøípadì normálního bìhu se èást finally provede a formuláø je uvolnìn z pamìti}
     finally
       Free;
     end;
   end;
 end;
 </pre>
<h2>Jak je mo¾né, ¾e si dovolím po chybì pokraèovat?</h2>
Pokud se vám povede dostat program do úzkých je mo¾né, ¾e se zobrazí informace
o tom, ¾e do¹lo k chybì, ale pøesto se program vìt¹inou zbrchá, nebo se zbrchá
natolik, ¾e se dá ukonèit. Je to mo¾né pomocí dùsledného pou¾ívání vyjímek
a jednoduchého fíglu. Úplnì na zaèátku programu je v bìhové knihovnì za¾ádáno
o alokaci nulté stránky virtuální pamìti procesu (mmap) a tato je oznaèena jako
nedostupná (resp. nedá se z ní èíst, zapisovat atd.). Vìt¹ina problémù s
tí, ¾e program ¹ahá kam nemá je zpùsobena tím, ¾e není inicializován pointer
(a co je jiného objekt ne¾ pointer?), tudí¾ kdy¾ se náhodou stane, ¾e zapomenu
inicializovat objekt, tak je velká pravdìpodobnost, ¾e se ¹áhne do zakázané
oblasti (vìt¹inou díky tomu, ¾e obsahuje buï nil (NULL v C) nebo nìjaké malé
èíslo), bìhová knihovna signál odchytí, transformuje na vyjímku, kterou buïto
zachytí nekterá z mojich obsluh, nebo v nejhopr¹ím pøípadì globální ovladaè
vyjímek. Mechanismus je samozøejmì slo¾itìj¹í a vstupuje do nìj i navíc sekce
finally atd.<br>
Abych se pøiznal, tak je jedna èást kódu která mù¾e zpùsobit problémy. Jedná
se o vykreslování panelu, nebo o vykreslování textové èásti Vieweru. Vykreslení
je zavoláno pokud je to tøeba, tj. napø.
pokud bylo zavøeno dialogové okno pøed ním. No a to je ten zakopanej pes.
Pokud to diloagové okno ukazovalo chybu, která vznikla pøi vykreslovaní panelu,
tak je prù¹vih. Následuje opìtovná chyba atd. a program se musí (s)prostì odstøelit.
Budu se toto sna¾it minimalizavat (konstrukce <TT>if assigned(objekt) then </TT>,
kde to assigned je optimalizovanou variantou objekt=nil.<br>
Samozøejmì pokud naleznete opakující se chybu, je dobré nám napsat a tam
samozøejmì pospat jak se dá vyvolat, popøípadì screenshot pomù¾e (co nejmen¹í velikost).
<h2><a name="mozTocId643223" class="mozTocH3"></a>Lokalizace<br></h2>
 V¹echny øetìzce (v souèasnosti to nejsou úplnì v¹echny) by mìly být lokalizovány.
Mechanismus je jednoduchý. Existují soubory *.lng, které obsahují v¹echny
texty s jedineèným èíselným identifikátorem. Pokud se pøidá dal¹í, je to
rozpoznáno a v konfiguraci se dá jazyk zvolit. Následnì v unitu <b>uLng</b> je dostupná
funkce <br>
 <tt>function lngGetString (id:Integer):String;</tt><br>
 která pro identifikátor vrátí øetìzec v nastaveném jazyku. Zároveò jsou zde
definovány konstanty jednotlivých textù. V¾dy se musí definovat konstanta
a nevolat uvedenou funkci s "tvrdou" hodnotou (i kdy¾ by to teoreticky ¹lo, ale byl by v tom
ehm nepoøádek). Nezapomenout, ¾e program se musí dát ovládat pouze z klávesnice, tj. &amp; znaèí shortcut,
i kdy¾ to napø. v menu zapomenete, bude to automaticky doplnìno, ale není to ko¹er.<br>
 
<h3><a name="mozTocId702853" class="mozTocH4"></a>Lokalizace formuláøù<br>
 </h3>
 Pokud se jedná o lokalizaci formuláøù, jsou v¹echny formuláøe následníkem
<tt>TFrmLng</tt> umístìného ve fLngForm.pas. Zatím tento formuláø pouze definuje
abstraktní funkci <tt>procedure LoadLng; virtual; abstract;</tt> která je
zavolána pøi vytvoøení formuláøe, musí být v následníku pøedefinována a slou¾í
pro lokalizaci prvkù ve formuláøi, pro to jak nahlédnìte do zdrojákù.<br>
 
<h3><a name="mozTocId969999" class="mozTocH4"></a>Lokalizované zprávy<br>
 </h3>
 Pro zabrazení hlá¹ek pou¾ívejte <tt>uShowMsg.pas</tt> v kombinaci s vý¹e
uvedeným mechanismem. Je zde definováno nìkolik obvyklých typù zpráv <tt>
(MsgOK, MsgError)</tt> a taky obecná <tt>MsgBox</tt>, která mù¾e zobrazit
libovolný poèet tlaèítek (pøeddefinované jsou snad v¹echny mo¾né, ale dají
se doplnit (nezapomenout pøidat popisy i do souborù lng).<br>
 
<h2><a name="mozTocId336128" class="mozTocH2"></a>Práce s archívy</h2>
 V souèasnosti SeksiCmd pou¾ívá na archívy externí skripty, v budoucnosti
uva¾uji i o pluginech (¹lo by to pak psát i v C). Jako základ jsou skripty
z mc. Pouze pøístup k nim je tro¹ièku jiný. Volání skriptu probíhá na základì
koncovky souboru, tj. zatím fungují pouze takovéto skripty (zip, rpm, deb...).
Pøiøazení souborù ke koncovkám je v souboru vfs/vfsini.ini.<br>
 <br>
 
<h2><a name="mozTocId648487" class="mozTocH3"></a>Portace</h2>
 Pøedem musím øíct, ¾e já sám zatím o portaci neuva¾uji. Ale jeliko¾ jsou
zdrojové kódy pod GPL, tak se tomu mù¾e zkusit vìnovat nìkdo jiný.<br>
 
<h3><a name="mozTocId994230" class="mozTocH4"></a>Windows</h3>
 SeksiCmd je psán speciálnì pro Linux a jako takový vyu¾ívá nìkteré jeho vlastnosti.
Týká se to hlavnì práce se soubory a s filesystemem. Pro nìkteré vìci (jako
mmap) existují ekvivalenty, pro jiné ne a ani to nebude potøeba (chown atd.).
Nìkde se bude muset nìco pøidat (práce s disky).<br>
 Pro pøeklad bude asi nutné Delphi 6 a vy¹¹í pokud by to mìla zùstat CLX aplikace
(sna¾¹í cesta).<br>
 Pokud by byl port úplný, tak se musí nahradit v¹echny Qt na nativní windows
prvky a muselo by se upravit èást UI (V tomto pøípadì by staèilo Delphi 5,
proto¾e program vyu¾ívá <tt>TFrame</tt> pro panely).<br>
 Ka¾dopádnì se musí pøeportovat moje komponenta <tt>QViewerControl</tt>, která
se stará o textovou èást Vieweru. Ale nemìlo by to být nic tì¾kého (a¾ na
to ¾e to pou¾ívá <tt>mmap</tt> souboru :-P ).<br>
 
<h3><a name="mozTocId60923" class="mozTocH4"></a>Lazarus</h3>
 Lazarus je klon Kylixe (<a href="http://lazarus.freepascal.org/">lazarus.freepascal.org</a>
). Pou¾ívá freepascal (není to frontend ke gcc a podporuje více architektur).
V souèasné dobì prý je docela schopný (lazarus). Lazurus je postaven na gtk+
a tudí¾ by ten pøepis musel být brutálnìj¹í (hlavnì okolí GUI) a nevím jak
moc je kompatibilní jeho knihovna.<br>
 <br>
 <br>
 
</body>
</html>
